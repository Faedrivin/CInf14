\documentclass{CInf_practice}

\sheet{10}{Beispiel CPUs HAM und H6809}

\begin{document}
\cinftitle

\ex{Befehlserweiterung der HAM}{5 + 7 + 9 + 5 + 3 + 3}

\subex{\bf SETA}
\lstinputlisting[language=RTeasy,firstline=50,lastline=53]{HAM_extended.rt}
\subex{\bf ADDI}
\lstinputlisting[language=RTeasy,firstline=55,lastline=58]{HAM_extended.rt}
\subex{\bf LOADI}
\lstinputlisting[language=RTeasy,firstline=60,lastline=64]{HAM_extended.rt}
\subex{\bf STOREI}
\lstinputlisting[language=RTeasy,firstline=66,lastline=70]{HAM_extended.rt}

\subex{Testprogramm}

Nach Ausführen des Tests muss an Speicherstelle 9 die Zahl 1 stehen und an 10
nur Einsen. Die Tabelle beinhaltet in der dritten Spalte eine zahl für den
Operanden in den unteren 8 Bit, die dem Opcode folgen (für Ein-Wort-Befehle) und
nach dem Komma den Operanden, der ggf. im zweiten Wort folgt.

\begin{assemblertable}
   0 & 9 & - & & SETA & - & Set accu to all ones \\\hline
   1 & A & -,2 & & ADDI & 2 & Add 2 to accu (will be 1 after) \\\hline
   3 & C & 9,- & & STOREI & 9 & Store accu at address positioned at mem(9)
   (which happens to be 9 again) \\\hline
   4 & B & A,- & & LOADI & 10 & Load value from address stored in mem(10) (which
   is again 10) \\\hline
   5 & 9 & - & & SETA & - & Set accu to all ones \\\hline
   6 & C & A,- & & STOREI & 10 & Store accu at address positioned at mem(10) \\\hline
   \vdots & & & & & & \\\hline
   9 & & & & .DB & 9 & Store value of 9 at position 9\\\hline
   A & & & & .DB & 10 & Store value of 10 at position 10\\\hline
\end{assemblertable}

\subex{Assemblat}

\lstinputlisting{aufg_1_test.mem} % sadly MikTeX can't interpret files without extensions which are not .tex here
                                  % wat ⦾ _ ⦾

\subex{Taktzahl}

Wenn man den FETCH-Zyklus ignoriert, der für alle Befehle gleich lang dauert,
ergeben sich folgende Laufzeiten:
\begin{ctabular}{>{\bf}lr}
   \toprule
   \normalfont{Befehl} & Taktzahl \\\midrule
   SETA & 4 \\
   ADDI & 4 \\
   LOADI & 5 \\
   STOREI & 5
\end{ctabular}

\ex{Collatz-Alg. auf der HAM}{18 + 10 + 4}

\subex{Assemblerprogramm}
\begin{assemblertable}
  00 & 1 & 13 & LOOP:   & LOAD   & VALUE  & load data VALUE     \\\hline
  01 & 4 & 14 &         & AND    & ODDBIT & check if even/odd   \\\hline
  02 & 6 & 0B &         & JUMPZ  & EVEN   & if even: jump       \\\hline
  03 & 1 & 13 & CHECK1: & LOAD   & VALUE  & else: check if 1    \\\hline
  04 & 4 & 15 &         & AND    & INVODD & if 1, then now 0    \\\hline
  05 & 6 & 12 &         & JUMPZ  & END    & if 0, then finish   \\\hline
  06 & 1 & 13 & ODD:    & LOAD   & VALUE  & odd case:           \\\hline
  07 & 3 & 13 &         & ADD    & VALUE  & multiply by 3 with  \\\hline
  08 & 3 & 13 &         & ADD    & VALUE  & \ additions and     \\\hline
  09 & 3 & 14 &         & ADD    & ODDBIT & add 1               \\\hline
  0A & 5 & 0D &         & JUMP   & COUNT  & count the step      \\\hline
  0B & 1 & 13 & EVEN:   & LOAD   & VALUE  &                     \\\hline
  0C & 8 & 00 &         & RSHIFT &        & divide by 2         \\\hline
  0D & 2 & 13 & COUNT:  & STORE  & VALUE  & store the new VALUE \\\hline
  0E & 1 & 16 &         & LOAD   & ERG    & load ERG            \\\hline
  0F & 3 & 14 &         & ADD    & ODDBIT & increment ERG       \\\hline
  10 & 2 & 16 &         & STORE  & ERG    & store ERG           \\\hline
  11 & 5 & 00 &         & JUMP   & LOOP   & repeat from start   \\\hline
  12 & 5 & 12 & END:    & JUMP   & END    & termination loop    \\\hline
  13 & 0 & 0D & VALUE   &        &      D & Input Value (13)    \\\hline
  14 & 0 & 01 & ODDBIT  &        &      1 & Mask: 000000000001  \\\hline
  15 & F & FE & INVODD  &        &    FFE & Mask: 111111111110  \\\hline
  16 & 0 & 00 & ERG     &        &      0 & Output Value        \\\hline
\end{assemblertable}

\subex{Handassemblierung}
\lstinputlisting{collatz_ham.mem}

\subex{Speicherbedarf und Laufzeit}
Speicherbedarf: $17 [Speicherstellen] \cdot 3 [\frac{Nibbles}{Speicherstelle}] \cdot 4 [\frac{Bit}{Nibble}] = 204 [Bit]$.

Laufzeit für $13$: 545 RT Takte bis \texttt{JUMPZ END} ausgeführt ist, danach beliebig viele Takte in \texttt{END: JUMP END}. 

\ex{Collatz-Alg. auf der H6809}{2 + 10 + 8 + 10 + 6}

\subex{}

Das X-Register kann z.B. genutzt werden, um den Iterationszähler zu speichern,
sodass dieser nicht immer im Hauptspeicher abgelegt und daraus geladen werden
muss.

\subex{Assemblerprogramm}

\begin{assemblertable}
0000   & 8E & 00     & INIT:     & LDX     & \#0     & Count iterations in X     \\\hline
0003   & B6 & 0030   & LOOP:     & LDA     & VALUE   & Load argument     \\\hline
0006   & 81 & 01     &           & CMPA    & \#1     & If 1, abort     \\\hline
0008   & 27 & 18     &           & BEQ     & END     & \\\hline
%    & B6 &        &           & LDA     & VALUE   & \textcolor{red}{necessary?} Load argument to subroutine \\\hline
000A   & BD & 0015   &           & JSR     & COLLATZ & Compute next value \\\hline
000D   & B7 & 0030   &           & STA     & VALUE   & Save new value \\\hline
0010   & 30 & 01     &           & ADDX    & \#1     & Increment count \\\hline
0013   & 20 & EF     &           & BRA     & LOOP    & And so on  \\\hline
0015   & 84 & 01     & COLLATZ:  & ANDA    & \#1     & check if odd     \\\hline
0017   & 26 & 0D     &           & BNE     & EVEN    & if not, branch     \\\hline
0019   & B6 & 0030   &           & LDA     & VALUE   & Restore VALUE     \\\hline
001C   & BB & 0030   & ODD:      & ADDA    & VALUE   &  $\times 2$     \\\hline
001F   & BB & 0030   &           & ADDA    & VALUE   &  $\times 3$     \\\hline
0022   & 8B & 01     &           & ADDA    & \#1     &  $+1$     \\\hline
0024   & 39 &        &           & RTS     &         &  Done.     \\\hline
0025   & 46 &        & EVEN:     & RORA    &         & Divide by 2     \\\hline
0026   & 84 & 80     &           & ANDA    & \#128   & Kill MSB     \\\hline
0028   & 39 &        &           & RTS     &         & Done.     \\\hline
0029   & BF & 002E   & END:      & STX     & ERG-1   & Store count.     \\\hline
002C   & 20 & 00     &           & BRA     & 0       & Infinite loop.     \\\hline
002E   &    &        &           & .BYTE   & 1       & Must be free to have low-byte of X stored at ERG    \\\hline
002F   &    &        & ERG       & .BYTE   & 1       & Allocate 1 byte for ERG.     \\\hline
0030   &    &        & VALUE     & .BYTE   & 1       & Allocate 1 byte for input.     \\\hline
\end{assemblertable}
\end{document}
